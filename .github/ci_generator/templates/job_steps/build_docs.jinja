<% extends 'steps' %>
<% block inner_steps %>
- name: Install Rust stable toolchain
  uses: actions-rust-lang/setup-rust-toolchain@v1.8.0
- name: Build API reference
  run: |
    cargo api_ref
- name: Copy API reference files
  run: |
    mkdir -p docs/api_reference
    cp -r target/doc/* docs/api_reference
- name: Install uv
  uses: astral-sh/setup-uv@v7
- name: Install the project
  run: uv sync --locked
- name: Build docs
  run: |
    uv run mkdocs build --strict
- uses: actions/upload-artifact@v5
  with:
    name: docs
    path: site/
- name: Fix base
  run: |
    # Convert all "absolute" guide links in the reference to relative links so that we can scan for dead links
    sudo find ./site -type f -exec sed -i "s#https://pavex.dev/docs/#file:///${PWD}/site/#g" {} +
    sudo find ./site -type f -exec sed -i "s#https://pavex.dev/#file:///${PWD}/site/#g" {} +
- name: Link Checker
  uses: lycheeverse/lychee-action@v2
  with:
    fail: true
    # Pinning since there seems to be an issue with index.html files
    # starting in 0.17.0
    lycheeVersion: v0.16.1
    args: |
      --base site
      --exclude-loopback
      --exclude-path="site/api_reference/pavex/http"
      --exclude-path="site/api_reference/pavex/time"
      --exclude-path="site/api_reference/help.html"
      --exclude-path="site/api_reference/settings.html"
      --exclude-path="site/404.html"
      --exclude=".*crate#per-style$"
      --exclude="https://doc.rust-lang.org/*"
      --exclude="https://stackoverflow.com/*"
      --exclude="https://github.com/LukeMathWalker/pavex/edit/main/*"
      --exclude="https://docs.rs/**/*"
      --exclude-path="site/api_reference/static.files"
      --exclude="https://fonts.gstatic.com"
      --require-https
      --no-progress
      site
<%- endblock %>
